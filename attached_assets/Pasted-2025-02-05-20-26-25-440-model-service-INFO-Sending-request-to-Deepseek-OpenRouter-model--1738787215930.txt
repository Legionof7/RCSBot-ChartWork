2025-02-05 20:26:25,440 - model_service - INFO - Sending request to Deepseek (OpenRouter): {'model': 'google/gemini-2.0-flash-lite-preview-02-05:free', 'messages': [{'role': 'system', 'content': '\nYou are an AI assistant for SlothMD. Generate JSON in this format to make your reply. The JSON must follow this format for RCS:\n\n{\n  "text": "Main message text",\n  "cards": [\n    {\n      "title": "Card title",\n      "subtitle": "Card subtitle (main content)",\n      "media_url": "{GRAPH_URL_N}",  // Use {GRAPH_URL_0}, {GRAPH_URL_1} etc for multiple graphs\n      "buttons": [\n        {\n          "title": "More Information",  // Always include for health information\n          "type": "trigger",\n          "payload": "more_info_[relevant_topic]"  // Replace [relevant_topic] with actual topic\n        }\n      ]\n    }\n  ],\n  "quick_replies": [\n    {\n      "title": "Quick reply text",\n      "type": "trigger",\n      "payload": "quick_reply_action"\n    }\n  ],\n  "graph": {\n    "type": "bar|line|scatter",\n    "data": {}  // Always include for broad metric-related queries asking about levels/numbers\n  }\n}\n\nImportant:\n1. All health information cards MUST include a "See More" button\n2. All metric-related queries MUST include a graph visualization\n3. Always include quick reply actions using the context of the metrics. You MUST have follow-up questions.:\nExamples:\n   - "Schedule Appointment" (payload: schedule_appointment)\n   - "View Care Plan" (payload: view_care_plan)\n   - "Contact Doctor" (payload: contact_doctor)\n   - "View Medications" (payload: view_medications)\n   - "Check Lab Results" (payload: check_labs)\n   - "Connect Wearable" (payload: connect_wearable) <-- send this when more data is requested/needed\n4. Use appropriate graph types:\n   - bar: for comparing values\n   - line: for trends over time\n   - scatter: for correlation analysis\n5. Titles MUST be under 25 characters in length.\n\nWhen including a graph, embed data using:\n\nGRAPH_DATA:{"type": "<graph_type>", "data": <data_object>}END_GRAPH_DATA\n\nSupported graph types and formats:\n\n1. Bar Chart:\nGRAPH_DATA:{"type": "bar", "data": {\n    "labels": ["Label1", "Label2", "Label3"],\n    "values": [10, 20, 30],\n    "title": "Bar Chart Title",\n    "xlabel": "Categories",\n    "ylabel": "Values",\n    "referenceLines": {"Label1": 15, "Label2": 25}\n}}END_GRAPH_DATA\n\n2. Line Chart:\nGRAPH_DATA:{"type": "line", "data": {\n    "x": ["2023-01", "2023-02", "2023-03"],\n    "y": [10, 20, 15],\n    "title": "Trend Analysis",\n    "xlabel": "Time Period",\n    "ylabel": "Values"\n}}END_GRAPH_DATA\n\n3. Scatter Plot:\nGRAPH_DATA:{"type": "scatter", "data": {\n    "x": [1, 2, 3, 4, 5],\n    "y": [2, 4, 3, 5, 4],\n    "title": "Correlation Plot",\n    "xlabel": "X Values",\n    "ylabel": "Y Values"\n}}END_GRAPH_DATA\n\n\nBelow is the patient\'s FHIR data (only address relevant healthcare questions):\n{\n  "resourceType": "Patient",\n  "id": "example",\n  "meta": {\n    "lastUpdated": "2024-01-22T12:00:00Z",\n    "profile": [\n      "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"\n    ]\n  },\n  "identifier": [\n    {\n      "system": "urn:oid:2.16.840.1.113883.19.5",\n      "value": "12345",\n      "type": {\n        "coding": [\n          {\n            "system": "http://terminology.hl7.org/CodeSystem/v2-0203",\n            "code": "MR",\n            "display": "Medical Record Number"\n          }\n        ]\n      }\n    }\n  ],\n  "active": true,\n  "name": [\n    {\n      "use": "official",\n      "family": "Smith",\n      "given": [\n        "John",\n        "Edward"\n      ],\n      "prefix": [\n        "Mr."\n      ]\n    }\n  ],\n  "telecom": [\n    {\n      "system": "phone",\n      "value": "+1-555-555-5555",\n      "use": "home"\n    },\n    {\n      "system": "email",\n      "value": "john.smith@email.com",\n      "use": "work"\n    }\n  ],\n  "gender": "male",\n  "birthDate": "1970-01-25",\n  "deceasedBoolean": false,\n  "address": [\n    {\n      "use": "home",\n      "type": "physical",\n      "line": [\n        "123 Main St"\n      ],\n      "city": "Boston",\n      "state": "MA",\n      "postalCode": "02115",\n      "country": "USA"\n    }\n  ],\n  "maritalStatus": {\n    "coding": [\n      {\n        "system": "http://terminology.hl7.org/CodeSystem/v3-MaritalStatus",\n        "code": "M",\n        "display": "Married"\n      }\n    ]\n  },\n  "communication": [\n    {\n      "language": {\n        "coding": [\n          {\n            "system": "urn:ietf:bcp:47",\n            "code": "en",\n            "display": "English"\n          }\n        ]\n      },\n      "preferred": true\n    }\n  ],\n  "medicalConditions": [\n    {\n      "code": "E11.9",\n      "system": "ICD-10",\n      "display": "Type 2 Diabetes",\n      "dateRecorded": "2020-03-15",\n      "status": "active"\n    },\n    {\n      "code": "I10",\n      "system": "ICD-10",\n      "display": "Hypertension",\n      "dateRecorded": "2019-06-22",\n      "status": "active"\n    }\n  ],\n  "medications": [\n    {\n      "name": "Metformin",\n      "code": "860975",\n      "system": "RxNorm",\n      "dosage": "500mg",\n      "frequency": "twice daily",\n      "startDate": "2020-03-15",\n      "status": "active"\n    },\n    {\n      "name": "Lisinopril",\n      "code": "203644",\n      "system": "RxNorm",\n      "dosage": "10mg",\n      "frequency": "once daily",\n      "startDate": "2019-06-22",\n      "status": "active"\n    }\n  ],\n  "vitalSigns": [\n    {\n      "date": "2024-01-15",\n      "bloodPressure": {\n        "systolic": 128,\n        "diastolic": 82,\n        "unit": "mmHg"\n      },\n      "heartRate": {\n        "value": 72,\n        "unit": "bpm"\n      },\n      "temperature": {\n        "value": 37.0,\n        "unit": "Celsius"\n      },\n      "weight": {\n        "value": 80.5,\n        "unit": "kg"\n      },\n      "height": {\n        "value": 180,\n        "unit": "cm"\n      }\n    }\n  ],\n  "labResults": [\n    {\n      "date": "2024-01-15",\n      "test": "HbA1c",\n      "value": 6.8,\n      "unit": "%",\n      "referenceRange": "4.0-5.6",\n      "interpretation": "High"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Cholesterol",\n      "value": 185,\n      "unit": "mg/dL",\n      "referenceRange": "125-200",\n      "interpretation": "Normal"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "HDL",\n      "value": 55,\n      "unit": "mg/dL",\n      "referenceRange": "40-60",\n      "interpretation": "Normal"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "LDL",\n      "value": 110,\n      "unit": "mg/dL",\n      "referenceRange": "0-100",\n      "interpretation": "Borderline High"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Triglycerides",\n      "value": 150,\n      "unit": "mg/dL",\n      "referenceRange": "0-150",\n      "interpretation": "Normal"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Fasting Glucose",\n      "value": 110,\n      "unit": "mg/dL",\n      "referenceRange": "70-100",\n      "interpretation": "High"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Creatinine",\n      "value": 1.1,\n      "unit": "mg/dL",\n      "referenceRange": "0.7-1.3",\n      "interpretation": "Normal"\n    }\n  ],\n  "carePlan": {\n    "created": "2024-01-15",\n    "status": "active",\n    "goals": [\n      "Maintain HbA1c below 7.0%",\n      "Blood pressure control below 130/80",\n      "Regular exercise 30 minutes daily",\n      "Follow diabetic diet plan"\n    ],\n    "nextReview": "2024-04-15"\n  },\n  "lastVisit": "2024-01-15",\n  "nextAppointment": "2024-02-15",\n  "emergencyContact": {\n    "relationship": "Spouse",\n    "name": "Jane Smith",\n    "phone": "+1-555-555-5556"\n  }\n}\n'}, {'role': 'user', 'content': 'test'}]}
2025-02-05 20:26:25,440 - model_service - INFO - Sending request to Deepseek (OpenRouter): {'model': 'google/gemini-2.0-flash-lite-preview-02-05:free', 'messages': [{'role': 'system', 'content': '\nYou are an AI assistant for SlothMD. Generate JSON in this format to make your reply. The JSON must follow this format for RCS:\n\n{\n  "text": "Main message text",\n  "cards": [\n    {\n      "title": "Card title",\n      "subtitle": "Card subtitle (main content)",\n      "media_url": "{GRAPH_URL_N}",  // Use {GRAPH_URL_0}, {GRAPH_URL_1} etc for multiple graphs\n      "buttons": [\n        {\n          "title": "More Information",  // Always include for health information\n          "type": "trigger",\n          "payload": "more_info_[relevant_topic]"  // Replace [relevant_topic] with actual topic\n        }\n      ]\n    }\n  ],\n  "quick_replies": [\n    {\n      "title": "Quick reply text",\n      "type": "trigger",\n      "payload": "quick_reply_action"\n    }\n  ],\n  "graph": {\n    "type": "bar|line|scatter",\n    "data": {}  // Always include for broad metric-related queries asking about levels/numbers\n  }\n}\n\nImportant:\n1. All health information cards MUST include a "See More" button\n2. All metric-related queries MUST include a graph visualization\n3. Always include quick reply actions using the context of the metrics. You MUST have follow-up questions.:\nExamples:\n   - "Schedule Appointment" (payload: schedule_appointment)\n   - "View Care Plan" (payload: view_care_plan)\n   - "Contact Doctor" (payload: contact_doctor)\n   - "View Medications" (payload: view_medications)\n   - "Check Lab Results" (payload: check_labs)\n   - "Connect Wearable" (payload: connect_wearable) <-- send this when more data is requested/needed\n4. Use appropriate graph types:\n   - bar: for comparing values\n   - line: for trends over time\n   - scatter: for correlation analysis\n5. Titles MUST be under 25 characters in length.\n\nWhen including a graph, embed data using:\n\nGRAPH_DATA:{"type": "<graph_type>", "data": <data_object>}END_GRAPH_DATA\n\nSupported graph types and formats:\n\n1. Bar Chart:\nGRAPH_DATA:{"type": "bar", "data": {\n    "labels": ["Label1", "Label2", "Label3"],\n    "values": [10, 20, 30],\n    "title": "Bar Chart Title",\n    "xlabel": "Categories",\n    "ylabel": "Values",\n    "referenceLines": {"Label1": 15, "Label2": 25}\n}}END_GRAPH_DATA\n\n2. Line Chart:\nGRAPH_DATA:{"type": "line", "data": {\n    "x": ["2023-01", "2023-02", "2023-03"],\n    "y": [10, 20, 15],\n    "title": "Trend Analysis",\n    "xlabel": "Time Period",\n    "ylabel": "Values"\n}}END_GRAPH_DATA\n\n3. Scatter Plot:\nGRAPH_DATA:{"type": "scatter", "data": {\n    "x": [1, 2, 3, 4, 5],\n    "y": [2, 4, 3, 5, 4],\n    "title": "Correlation Plot",\n    "xlabel": "X Values",\n    "ylabel": "Y Values"\n}}END_GRAPH_DATA\n\n\nBelow is the patient\'s FHIR data (only address relevant healthcare questions):\n{\n  "resourceType": "Patient",\n  "id": "example",\n  "meta": {\n    "lastUpdated": "2024-01-22T12:00:00Z",\n    "profile": [\n      "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"\n    ]\n  },\n  "identifier": [\n    {\n      "system": "urn:oid:2.16.840.1.113883.19.5",\n      "value": "12345",\n      "type": {\n        "coding": [\n          {\n            "system": "http://terminology.hl7.org/CodeSystem/v2-0203",\n            "code": "MR",\n            "display": "Medical Record Number"\n          }\n        ]\n      }\n    }\n  ],\n  "active": true,\n  "name": [\n    {\n      "use": "official",\n      "family": "Smith",\n      "given": [\n        "John",\n        "Edward"\n      ],\n      "prefix": [\n        "Mr."\n      ]\n    }\n  ],\n  "telecom": [\n    {\n      "system": "phone",\n      "value": "+1-555-555-5555",\n      "use": "home"\n    },\n    {\n      "system": "email",\n      "value": "john.smith@email.com",\n      "use": "work"\n    }\n  ],\n  "gender": "male",\n  "birthDate": "1970-01-25",\n  "deceasedBoolean": false,\n  "address": [\n    {\n      "use": "home",\n      "type": "physical",\n      "line": [\n        "123 Main St"\n      ],\n      "city": "Boston",\n      "state": "MA",\n      "postalCode": "02115",\n      "country": "USA"\n    }\n  ],\n  "maritalStatus": {\n    "coding": [\n      {\n        "system": "http://terminology.hl7.org/CodeSystem/v3-MaritalStatus",\n        "code": "M",\n        "display": "Married"\n      }\n    ]\n  },\n  "communication": [\n    {\n      "language": {\n        "coding": [\n          {\n            "system": "urn:ietf:bcp:47",\n            "code": "en",\n            "display": "English"\n          }\n        ]\n      },\n      "preferred": true\n    }\n  ],\n  "medicalConditions": [\n    {\n      "code": "E11.9",\n      "system": "ICD-10",\n      "display": "Type 2 Diabetes",\n      "dateRecorded": "2020-03-15",\n      "status": "active"\n    },\n    {\n      "code": "I10",\n      "system": "ICD-10",\n      "display": "Hypertension",\n      "dateRecorded": "2019-06-22",\n      "status": "active"\n    }\n  ],\n  "medications": [\n    {\n      "name": "Metformin",\n      "code": "860975",\n      "system": "RxNorm",\n      "dosage": "500mg",\n      "frequency": "twice daily",\n      "startDate": "2020-03-15",\n      "status": "active"\n    },\n    {\n      "name": "Lisinopril",\n      "code": "203644",\n      "system": "RxNorm",\n      "dosage": "10mg",\n      "frequency": "once daily",\n      "startDate": "2019-06-22",\n      "status": "active"\n    }\n  ],\n  "vitalSigns": [\n    {\n      "date": "2024-01-15",\n      "bloodPressure": {\n        "systolic": 128,\n        "diastolic": 82,\n        "unit": "mmHg"\n      },\n      "heartRate": {\n        "value": 72,\n        "unit": "bpm"\n      },\n      "temperature": {\n        "value": 37.0,\n        "unit": "Celsius"\n      },\n      "weight": {\n        "value": 80.5,\n        "unit": "kg"\n      },\n      "height": {\n        "value": 180,\n        "unit": "cm"\n      }\n    }\n  ],\n  "labResults": [\n    {\n      "date": "2024-01-15",\n      "test": "HbA1c",\n      "value": 6.8,\n      "unit": "%",\n      "referenceRange": "4.0-5.6",\n      "interpretation": "High"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Cholesterol",\n      "value": 185,\n      "unit": "mg/dL",\n      "referenceRange": "125-200",\n      "interpretation": "Normal"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "HDL",\n      "value": 55,\n      "unit": "mg/dL",\n      "referenceRange": "40-60",\n      "interpretation": "Normal"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "LDL",\n      "value": 110,\n      "unit": "mg/dL",\n      "referenceRange": "0-100",\n      "interpretation": "Borderline High"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Triglycerides",\n      "value": 150,\n      "unit": "mg/dL",\n      "referenceRange": "0-150",\n      "interpretation": "Normal"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Fasting Glucose",\n      "value": 110,\n      "unit": "mg/dL",\n      "referenceRange": "70-100",\n      "interpretation": "High"\n    },\n    {\n      "date": "2024-01-15",\n      "test": "Creatinine",\n      "value": 1.1,\n      "unit": "mg/dL",\n      "referenceRange": "0.7-1.3",\n      "interpretation": "Normal"\n    }\n  ],\n  "carePlan": {\n    "created": "2024-01-15",\n    "status": "active",\n    "goals": [\n      "Maintain HbA1c below 7.0%",\n      "Blood pressure control below 130/80",\n      "Regular exercise 30 minutes daily",\n      "Follow diabetic diet plan"\n    ],\n    "nextReview": "2024-04-15"\n  },\n  "lastVisit": "2024-01-15",\n  "nextAppointment": "2024-02-15",\n  "emergencyContact": {\n    "relationship": "Spouse",\n    "name": "Jane Smith",\n    "phone": "+1-555-555-5556"\n  }\n}\n'}, {'role': 'user', 'content': 'test'}]}
2025-02-05 20:26:26,853 - model_service - INFO - Deepseek response: {'id': 'gen-1738787185-JV0iGiKVAUtmouMzP5yi', 'provider': 'Google AI Studio', 'model': 'google/gemini-2.0-flash-lite-preview-02-05', 'object': 'chat.completion', 'created': 1738787185, 'choices': [{'logprobs': None, 'finish_reason': 'stop', 'native_finish_reason': 'STOP', 'index': 0, 'message': {'role': 'assistant', 'content': '```json\n{\n  "text": "Hello! How can I assist you today?",\n  "cards": [],\n  "quick_replies": [\n    {\n      "title": "Check Lab Results",\n      "type": "trigger",\n      "payload": "check_labs"\n    },\n    {\n      "title": "View Medications",\n      "type": "trigger",\n      "payload": "view_medications"\n    },\n    {\n      "title": "View Care Plan",\n      "type": "trigger",\n      "payload": "view_care_plan"\n    }\n  ],\n  "graph": {}\n}\n```', 'refusal': None}}], 'usage': {'prompt_tokens': 2707, 'completion_tokens': 141, 'total_tokens': 2848}}
2025-02-05 20:26:26,853 - model_service - INFO - Deepseek response: {'id': 'gen-1738787185-JV0iGiKVAUtmouMzP5yi', 'provider': 'Google AI Studio', 'model': 'google/gemini-2.0-flash-lite-preview-02-05', 'object': 'chat.completion', 'created': 1738787185, 'choices': [{'logprobs': None, 'finish_reason': 'stop', 'native_finish_reason': 'STOP', 'index': 0, 'message': {'role': 'assistant', 'content': '```json\n{\n  "text": "Hello! How can I assist you today?",\n  "cards": [],\n  "quick_replies": [\n    {\n      "title": "Check Lab Results",\n      "type": "trigger",\n      "payload": "check_labs"\n    },\n    {\n      "title": "View Medications",\n      "type": "trigger",\n      "payload": "view_medications"\n    },\n    {\n      "title": "View Care Plan",\n      "type": "trigger",\n      "payload": "view_care_plan"\n    }\n  ],\n  "graph": {}\n}\n```', 'refusal': None}}], 'usage': {'prompt_tokens': 2707, 'completion_tokens': 141, 'total_tokens': 2848}}
2025-02-05 20:26:30,706 - werkzeug - INFO - 172.31.128.27 - - [05/Feb/2025 20:26:30] "POST / HTTP/1.1" 200 -